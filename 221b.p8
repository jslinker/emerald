pico-8 cartridge // http://www.pico-8.com
version 32
__lua__

#include roomrunner.lua
#include object.lua
#include textbox.lua
#include fades.lua

function _init()
	frameCounter = 0

	local player = create(10, 4)
	player:setSprites(99, 96, 102, 104, 100, 97)

	RoomRunner:addMainPlayer(player)
	RoomRunner:addPlayer(makeMrsHudson())
	RoomRunner:addPlayer(makeLestrade())

	RoomRunner.room = createRoom(0, 0, 64, 128)
	RoomRunner.pallete = {0, 1, 130, 3, 132, 5, 6, 7, 136, 9, 10, 11, 12, 13, 143, 15}
	RoomRunner.triggerFunction = function() checkTriggers() end

	-- Fireplace
	RoomRunner:addAnimatedTile(100, 8, 32, {13, 14, 15})
	RoomRunner:addAnimatedTile(101, 8, 32, {15, 13, 14})
	RoomRunner:addAnimatedTile(99, 8, 32, {14, 15, 13})

	-- Boiling pot
	RoomRunner:addAnimatedTile(52, 52, 8, {14, 15, 13})

	-- Lanterns
	RoomRunner:addAnimatedTile(40, 4, 28, {30, 31})
	RoomRunner:addAnimatedTile(72, 4, 28, {30, 31})

	-- Text in the room
	RoomRunner:addTextTrigger(14, 2, "MY FAVORITE CHAIR.\nPERFECT FOR INTERVIEWING\nCLIENTS.")
	RoomRunner:addTextTrigger(10, 2, "THE DOCTORS CHAIR.\nI WISH HE'D THROW OUT\nTHAT HIDEOUS THING.\nIT IS COMFORTABLE THOUGH.\nOH WELL...")
	RoomRunner:addTextTrigger(10, 6, "A FULL ENGLISH BREAKFAST\nBUT I'M DONE FOR NOW.")
	RoomRunner:addTextTrigger(14, 6, "THE DOCTOR LEFT WITHOUT\nCLEANING HIS PLATE...")
	RoomRunner:addTextTrigger(6, 6, "ANOTHER DELICIOUS BREAKFAST\nBY \f8mrs. hudson\f1\nWE REALLY DON'T DESERVE HER.")
	RoomRunner:addTextTrigger(12, 0, "POOR YORK.\nI KNEW HIM WELL.")
end

function _update()
	RoomRunner:update()
end

function _draw()
	fadeIn()
	RoomRunner:draw()
end

function fadeIn()
	if frameCounter < 1000 then frameCounter += 1 end
	if frameCounter / 4 < 16 then fadeFromBlack(frameCounter / 4) end
end

function makeMrsHudson()
	local player = create(8, 6)
	player:setSprites(65, 64, 66, 0, 0, 0)
	player.animationFrame = "left"
	player.name = "mrs. hudson"
	player.speech = "\f8mrs. hudson\f1:\nI'VE GOT MORE BREAKFAST\nCOOKING BUT REMEMBER,\nI'M YOUR LANDLADY\nNOT YOUR MAID.\nIF YOU'RE BORED\nI THINK \f8lestrade\f1 COULD\nUSE YOUR HELP."
	return player
end

function makeLestrade()
	local player = create(2, 2)
	player:setSprites(74, 68, 72, 0, 70, 0)
	player.id = 1
	player.name = "detective lestrade"
	player.speech = "\f8detective lestrade\f1:\nI NEED YOUR HELP.\nTHE POLICE ARE STUMPED.\nTHERE'S BEEN A \f8murder\f1 IN THE\nROYAL FAMILY.\nMEET ME AT THE\n\f8abandoned house\f1\nON THE \f8east side\f1 OF TOWN.\nI'LL BE THERE WITH THE REST\nOF THE POLICE."
	return player
end

function checkTriggers()
	-- Lestrade leaves
	if RoomRunner.focusedPlayer != nil and RoomRunner.focusedPlayer.id == 1 then
		local lestrade = RoomRunner.focusedPlayer
		local frame = lestrade.animationFrame
		
		RoomRunner:move(lestrade, 0, -1, "up")
		add(lestrade.animations, {type="callback", callback = function() RoomRunner.pauseInput = false end })
		add(lestrade.animations, {type="callback", callback = function() RoomRunner:removePlayer(lestrade) end })
		-- Animation built in reverse order
		for i=0,16 do
			add(lestrade.animations, {animationFrame="up", x=0, y=16}, 1)
		end
		for i=0,16 do
			add(lestrade.animations, {animationFrame=frame, x=0, y=16}, 1)
		end
		RoomRunner.pauseInput = true
	end
end

__gfx__
0000000066666666d2dddd2d1111111144444444444444444444444422222222111111111111111162822888888228225566666600000000000000000000a000
0000000067766666dddddddd515151514466664444444444444444441111111151515151515151516222222222222222655566660000000000000a0000000000
0070070067766666d2dddd2dd5d5d5d546993364444444444444444455555555d5d5d5d5dd77ddd56282288888822822675656660000a0000000000000a00000
0007700066666666dddddddddddddddd46995362444444444444444455555555ddddddddd7777ddd622222222222222266666666000000000a00000000000000
0007700066666666d2dddd2dd2dddd2d46855a62424444244444444466666666d2dddd2dd575722d62822888888228226666666600a000a00000000000a00000
0070070066666776dddddddddddddddd46885a62444442444444444466666776444444444777244462222222222222226666677609090000090a0900090000a0
0000000066666776ffffffffd2dddd2d4266662444444444444444446666677644444444422244446282288888822822666667750000909000909a9000909000
000000006666666611111111dddddddd442222444444444444444444666666664444444444444444622222222222222266666656000000000000000000000000
11111111111111115566666666666551666666666666666666664444444466662221111111111222d2dddd2dddddddddd2dddd2dd2dddd2d00ee0e00000ee000
51515151515151515676767676767651677666661166666667444444444444764241111111111424dddddddddddddddddddddddddddddddd0e0000e000000000
d5d5d5d5d5d5d5d55665656565656651655555511155555664444444444444462225151515151222d2dddd2dddddddddd2dddddddddddd2d00000000e000a00e
11111111111111115665656565656651566666611666666564444444444444464441515151515444ddddddddddd8888dddd44ddddddddddd0e0a00e0000a0000
12222222222222215661616161616651566666611666666144444444444444442225555555555222d2dddd2ddd888888dd4444dddddddd2d00e0ae00e00aa00e
12424242424242215666666666666651566111111111166144444444444444444245555555555424ddd8888882888882dd4444dddddddddd000770000e0770e0
12444444444444215566666666666551561555555555516144444444444444442226666666666222ff88888828888882f1444411111111ff0007700000077000
1244444444444421555555555555555151155599a955511144444444444444444446666666666444118888882888888812444424444444110001100000011000
14444444444444411111111111111111511a99999999911144444444444444446644666666666666668222222888888262444424444444460000000000000000
12444444444444212222222222222221511999a999a9911144444444444444446744244444444466662888882888888262444424444444460000000000000000
14444444444444414444444444444441511999999999911144444444444444446244244444424446668888882888888862444424444244460000000000000000
14771444444444414444444444444441511999999999911124444444444444426244244444442446828888882888888262444424444424460000000000000000
14775144444444414444444444444441512111111111151114444444444444416244244444444446828888222222222262422424444444460000000000000000
14551444444444414444444444444441512555555557251112444444444444216244244444444446828822888888888262244224444444460000000000000000
1444444444444441ffffffffffffffff561555555557216161224444444422166244244444444446828288282882882862444424444444460000000000000000
1ffffffffffffff11111111111111116566111111111166161112222222211166222244444444446828288888888888264222222222244460000000000000000
00000000000000000000000000000000000000000000000062211111111112266244244444442446822888888888888262444444444424460000000000000000
00000000000000000000000000000000000000000000000064415555555514466244244444444446822888888888888862444444444442460000000000000000
00000000000000000000000000000000000000000000000064415666666514466422244444444446822888888888888264244444444442460000000000000000
00000000000000000000000000000000000000000000000066666666666666666242444444424426882888888888888262424444444244260000000000000000
00000000000000000000000000000000000000000000000066666666666666666122222222222216188222222222222161222222222222160000000000000000
00000000000000000000000000000000000000000000000067766666666677666614411111144176144111111111441166144111111441760000000000000000
00000000000000000000000000000000000000000000000067766666666677666664477666644776611111111111111666644776666447760000000000000000
00000000000000000000000000000000000000000000000066666666666666666666666666666666666666666666666666666666666666660000000000000000
000000dd00000ddd00000000dd000000000011111111000000001111111100000000111110000000000011110000000000000000000000000000000000000000
00000566000056660000000d665000000001dddddddd10000001dddddddd100000011dddd11000000001dddd0000000000000000000000000000000000000000
0000056d000556660000555d66600000001dddddddddd100001dddddddddd1000001ddddddd11000001ddddd0000000000000000000000000000000000000000
0005665d005665dd005566656d0000000011dddddddd11000011dddddddd110000011dddddddd1000011dddd0000000000000000000000000000000000000000
005666d605666d6605666ddd5d600000001111111111110000111111111111000001111ddddddd10001111110000000000000000000000000000000000000000
005d6ddd0566dd665dd666666555000001f1111aa1111f1001e5111111115e10001191111111111001e511110000000000000000000000000000000000000000
005ddfff0566d6662ffffddddddd500001e2111991112e1001e5511111155e10001111111111110001e551110000000000000000000000000000000000000000
000de21f2fd6d6662fffffd55ddd50000012e111111e210000155222222551000001ff1ee5fe1000001552220000000000000000000000000000000000000000
0000eeff2f5ddd662ff02fdfe5d50000001eef1ff1fee100016155222255100000002e2ffeee1000016155220000000000000000000000000000000000000000
00021eef025ddddd02eeeeefe55d20000001ee2ff2ee1000016d115555111000000002eeee511000016d11550000000000000000000000000000000000000000
0022c21102255ddd0022eeee52ccd200001912eeee219100001d91111119d1000000012211911000001d91110000000000000000000000000000000000000000
002dcc2d22dc255500022225cdcc220001dd91111119dd10001191dddd19d710000001d111191000001191dd0000000000000000000000000000000000000000
00dddccd2ccccccc000001ccc2d2ff2001761d7117d1671000011dddddd11710000000117711000000011ddd0000000000000000000000000000000000000000
000ddddc2ccc2dcc000002cdcc22ff2000111dd66dd1110000011dddd11111000000001d11d1000000011ddd0000000000000000000000000000000000000000
000022cd00022ddd0000002ccc222000000122199122100000012221110000000000001222100000000122210000000000000000000000000000000000000000
00000220000022000000000222220000000111d11d11100000001110000000000000000111000000000011100000000000000000000000000000000000000000
00000111000000000000000000000111000000000000000000000111111000000000000000000000000000000000000000000000000000000000000000000000
00001555000001111110000000001555000001111110000000001555555100000000011111100000000000000000000000000000000000000000000000000000
00015555000015555551000000015555000015555551000000015555555510000000155555510000000000000000000000000000000000000000000000000000
00015555000155555555100000015555000155555555100000117555555510000001555555551000000000000000000000000000000000000000000000000000
00111577000155555555100000115555001155555555100001777755555111000011755555551000000000000000000000000000000000000000000000000000
00117111001115777751110000111555001155555555110000115551111111000177775555511100000000000000000000000000000000000000000000000000
01717777001111111111110001711111017115555551171000017177111111000011555111111100000000000000000000000000000000000000000000000000
01777717017177777777171001771111017711111111771000017177177110000001717711111100000000000000000000000000000000000000000000000000
00117717017777177177771000117711011177111177110000017777777100000001717717711000000000000000000000000000000000000000000000000000
00111775011177177177110000111155017111555511110000001577711510000001777777710000000000000000000000000000000000000000000000000000
01771111017117755771510001711511001115111151771000000111115510000000157771151000000000000000000000000000000000000000000000000000
01771111001111111111710001711557000115577551771000000011771510000000011111151000000000000000000000000000000000000000000000000000
00111551000115111177110000111155000115555511110000000011771510000001111117711000000000000000000000000000000000000000000000000000
00015115000011155177100000015111000011111100000000000155111100000015515517715100000000000000000000000000000000000000000000000000
00015551000015511011000000015551000015110000000000000155551000000001551111155100000000000000000000000000000000000000000000000000
00001110000001110000000000001110000001110000000000000011110000000000111000011000000000000000000000000000000000000000000000000000
__gff__
0100010101010101010100000000000000000101010101010101010101010000000001010000010101010101010100000000000000000101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0303101103030303030303030809030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020220210202020202021c1d18191a1b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c010a0b0101010101012c2d01012a2b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010101010101010101013c3d01013a3b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000001415010116040605041700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000002425010106050606060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000001213010126060604062700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000022230c0136070707073700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
